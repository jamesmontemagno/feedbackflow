@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IAuthTokenRefreshService TokenRefreshService
@inject ILogger<MainLayout> Logger

<div class="page d-flex flex-column min-vh-100">
    <!-- Desktop Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4 d-none d-lg-block">
        <div class="container">
            <a href="/" class="navbar-brand d-flex align-items-center">
                <img src="logo-feedbackflow.svg" alt="FeedbackFlow Logo" width="36" height="36" class="me-2" style="filter: brightness(0) invert(1);" />
                <span>FeedbackFlow</span>
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link @(IsActive("/") ? "active" : "")" href="/">
                            <i class="bi bi-chat-dots me-1"></i>
                            Analyze
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(IsActive("/content-feeds") ? "active" : "")" href="/content-feeds">
                            <i class="bi bi-collection me-1"></i>
                            Feeds
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(IsActive("/reports") ? "active" : "")" href="/reports">
                            <i class="bi bi-graph-up me-1"></i>
                            Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(IsActive("/history") ? "active" : "")" href="/history">
                            <i class="bi bi-cloud-upload me-1"></i>
                            <span>Saved</span>
                        </a>
                    </li>
                </ul>
            </div>            
            <div class="ms-auto d-flex align-items-center">
                <div class="navbar-utility-actions d-flex align-items-center me-3">
                    <a class="utility-action @(IsActive("/whats-new") ? "active" : "")" href="/whats-new" title="What's New">
                        <i class="bi bi-stars"></i>
                    </a>
                    <a class="utility-action @(IsActive("/settings") ? "active" : "")" href="/settings" title="Settings">
                        <i class="bi bi-gear"></i>
                    </a>
                </div>
                <div class="me-3">
                    <ThemeToggle />
                </div>
                <UserNavigation />
            </div>
        </div>
    </nav>

    <!-- Mobile Header -->
    <div class="mobile-header d-lg-none">
        <div class="mobile-header-content">
            <div class="mobile-user-section">
                <UserNavigation />
            </div>
            <div class="mobile-page-title">
                @GetCurrentPageTitle()
            </div>
            <div class="mobile-utility-actions">
                <a class="mobile-utility-action @(IsActive("/whats-new") ? "active" : "")" href="/whats-new" title="What's New">
                    <i class="bi bi-stars"></i>
                </a>
                <ThemeToggle />
            </div>
        </div>
    </div>
    
    <main class="container-fluid flex-grow-1 @(GetMainClasses())">
        @Body
    </main>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav d-lg-none">
        <div class="mobile-nav-items">
            <a href="/" class="mobile-nav-item @(IsActive("/") ? "active" : "")" title="Analyze">
                <i class="bi bi-chat-dots"></i>
                <span>Analyze</span>
            </a>
            <a href="/content-feeds" class="mobile-nav-item @(IsActive("/content-feeds") ? "active" : "")" title="Feeds">
                <i class="bi bi-collection"></i>
                <span>Feeds</span>
            </a>
            <a href="/reports" class="mobile-nav-item @(IsActive("/reports") ? "active" : "")" title="Reports">
                <i class="bi bi-graph-up"></i>
                <span>Reports</span>
            </a>
            <a href="/history" class="mobile-nav-item @(IsActive("/history") ? "active" : "")" title="Saved">
                <i class="bi bi-cloud-upload"></i>
                <span>Saved</span>
            </a>
            <a href="/settings" class="mobile-nav-item @(IsActive("/settings") ? "active" : "")" title="Settings">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </div>
    </nav>
    
    <!-- Desktop Footer -->
    <div class="d-none d-lg-block">
        <Footer />
    </div>
    <ToastNotification />
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                await JSRuntime.InvokeVoidAsync("initTheme");
            }
            catch
            {
                // Silently ignore any JavaScript errors
            }

            // Initialize automatic token refresh
            try
            {
                await TokenRefreshService.InitializeAsync();
                await TokenRefreshService.StartAutoRefreshAsync();
                Logger.LogInformation("Authentication token refresh started in MainLayout");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to start authentication token refresh in MainLayout");
            }
        }
    }

    private bool IsActive(string path) => 
        NavigationManager.Uri.EndsWith(path, StringComparison.OrdinalIgnoreCase);

    private string GetCurrentPageTitle()
    {
        var uri = new Uri(NavigationManager.Uri);
        var path = uri.LocalPath.ToLowerInvariant();
        
        return path switch
        {
            "/" => "Analyze",
            "/content-feeds" => "Feeds", 
            "/reports" => "Reports",
            "/history" => "Saved",
            "/settings" => "Settings",
            "/whats-new" => "What's New",
            "/account-settings" => "Account",
            "/history-local" => "Local History",
            var p when p.StartsWith("/reports/") => "Reports",
            var p when p.StartsWith("/report/") => "Report Details",
            var p when p.StartsWith("/analysis/") => "Analysis",
            var p when p.StartsWith("/shared/") => "Shared Analysis",
            _ => "FeedbackFlow"
        };
    }

    private string GetMainClasses()
    {
        // Add padding bottom for mobile to account for bottom navigation
        return "pb-4 pb-mobile-nav";
    }
}
