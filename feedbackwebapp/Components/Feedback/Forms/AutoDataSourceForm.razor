@namespace FeedbackWebApp.Components.Feedback.Forms
@using System.ComponentModel.DataAnnotations
@using SharedDump.Utils
@using SharedDump.Models.YouTube

<div class="auto-input-container">
    <div class="auto-input-list">
        @for (var i = 0; i < Urls.Count; i++)
        {            
            var index = i;
            <div class="url-entry-container mb-3">
                <div class="input-group">
                    @* Show YouTube content type selector on the left if this is a YouTube URL *@
                    @if (!string.IsNullOrWhiteSpace(Urls[index]) && UrlParsing.IsYouTubeUrl(Urls[index]))
                    {
                        <YouTubeContentTypeSelector 
                            SelectedContentType="@YouTubeContentTypes[index]"
                            SelectedContentTypeChanged="@(async (type) => await HandleContentTypeChange(index, type))"
                            IsDisabled="@IsDisabled"
                            InputId="@($"yt-{index}")" />
                    }
                    
                    <div class="form-floating flex-grow-1">
                        <input type="url" 
                               class="form-control" 
                               id="url-@index"
                               value="@Urls[index]"
                               disabled="@IsDisabled"
                               @onchange="@(async (ChangeEventArgs e) => await HandleUrlChange(index, e.Value?.ToString() ?? ""))" />
                        <label for="url-@index">Enter URL</label>
                    </div>
                    <button class="btn btn-outline-danger" 
                            @onclick="@(() => RemoveUrl(index))" 
                            disabled="@IsDisabled"
                            type="button">
                        <i class="bi bi-x-lg"></i>
                        <span class="visually-hidden">Remove URL</span>
                    </button>
                </div>
            </div>
        }
    </div>

    <button class="btn btn-outline-primary mb-3" 
            @onclick="AddUrl" 
            disabled="@IsDisabled"
            type="button">
        <i class="bi bi-plus-lg"></i> Add Another URL
    </button>

    @* Show individual reports option when multiple URLs are present! *@
    @if (Urls.Count(u => !string.IsNullOrWhiteSpace(u)) > 1)
    {
        <div class="toggle-option-container">
            <div class="toggle-switch">
                <input type="checkbox" 
                       id="includeIndividualReports"
                       class="toggle-switch-checkbox"
                       @bind="IncludeIndividualReports" 
                       disabled="@IsDisabled" />
                <label class="toggle-switch-label" for="includeIndividualReports">
                    <span class="toggle-switch-inner"></span>
                    <span class="toggle-switch-switch"></span>
                </label>
            </div>
            <div class="toggle-content">
                <div class="toggle-title">Include individual reports for each URL</div>
                <div class="toggle-description">
                    By default, only a combined analysis is generated. Enable this to also get separate analysis for each URL.
                </div>
            </div>
        </div>
    }
</div>

@code {    
    private List<string> Urls { get; set; } = new() { "" };
    private Dictionary<int, YouTubeContentType> YouTubeContentTypes { get; set; } = new();

    [Parameter]
    public EventCallback<List<string>> OnUrlsChanged { get; set; }
    
    [Parameter]
    public EventCallback OnContentTypeChanged { get; set; }

    [Parameter]
    public bool IsDisabled { get; set; }

    [Parameter]
    public bool IncludeIndividualReports { get; set; } = false;

    [Parameter]
    public EventCallback<bool> IncludeIndividualReportsChanged { get; set; }

    public async Task HandleUrlChange(int index, string value)
    {
        // Ensure we have enough slots in the list
        while (Urls.Count <= index)
        {
            Urls.Add("");
        }
        
        Urls[index] = value;
        
        // Initialize YouTube content type for new YouTube URLs (default to Comments)
        if (!string.IsNullOrWhiteSpace(value) && UrlParsing.IsYouTubeUrl(value) && !YouTubeContentTypes.ContainsKey(index))
        {
            YouTubeContentTypes[index] = YouTubeContentType.Comments;
        }
        
        await OnUrlsChanged.InvokeAsync(Urls);
        StateHasChanged(); // Refresh to show/hide YouTube selector and checkbox
    }
    
    private async Task HandleContentTypeChange(int index, YouTubeContentType newType)
    {
        YouTubeContentTypes[index] = newType;
        
        // Notify parent that content type changed (triggers invalidation/re-fetch)
        await OnContentTypeChanged.InvokeAsync();
    }

    private void AddUrl()
    {
        Urls.Add("");
        StateHasChanged(); // Refresh to show/hide checkbox
    }

    private async Task RemoveUrl(int index)
    {
        if (Urls.Count > 1)
        {
            Urls.RemoveAt(index);
            YouTubeContentTypes.Remove(index);
            
            // Re-index the dictionary
            var newDict = new Dictionary<int, YouTubeContentType>();
            foreach (var kvp in YouTubeContentTypes.OrderBy(k => k.Key))
            {
                var newIndex = kvp.Key > index ? kvp.Key - 1 : kvp.Key;
                newDict[newIndex] = kvp.Value;
            }
            YouTubeContentTypes = newDict;
            
            await OnUrlsChanged.InvokeAsync(Urls);
            StateHasChanged(); // Refresh to show/hide checkbox
        }
    }

    public void RefreshUI() => StateHasChanged();
    
    public List<string> GetUrls() => Urls.Where(u => !string.IsNullOrWhiteSpace(u)).ToList();
    
    public bool GetIncludeIndividualReports() => IncludeIndividualReports;
    
    public Dictionary<string, YouTubeContentType> GetYouTubeContentTypes()
    {
        var result = new Dictionary<string, YouTubeContentType>();
        for (int i = 0; i < Urls.Count; i++)
        {
            if (!string.IsNullOrWhiteSpace(Urls[i]) && UrlParsing.IsYouTubeUrl(Urls[i]))
            {
                result[Urls[i]] = YouTubeContentTypes.TryGetValue(i, out var contentType) 
                    ? contentType 
                    : YouTubeContentType.Comments; // Default to Comments
            }
        }
        return result;
    }
}
